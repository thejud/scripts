#!/usr/bin/env ruby

require 'optparse'
require 'logger'
require 'find'

$log=Logger.new STDERR

########################################
# FUNCTIONS
########################################

def parse_args
  o = {}
  OptionParser.new do |opts|
    opts.banner = "Usage: #{File.basename(__FILE__)} [options]"
    opts.on("-h", "--help", "Show help") do
     puts opts
     exit
    end
    opts.on("-q", "--quiet", "Quiet. Decrease verbosity only. Can be repeated") do
      o[:quiet] ||= 0
      o[:quiet] += 1 if o[:quiet] < 2
    end
    opts.on("-p", "--path", "Match full path, not just basename") do 
      o[:path] = true
    end
    opts.on("-d", "--dir", "Match directories, not just files") do
      o[:dirs] = true
    end
  end.parse!
  return o
end

def main
  opts = parse_args
  pattern = ARGV.shift || '.'
  dir = ARGV.shift || '.'
  pattern = Regexp.new(pattern)
  Find.find(dir) do |path|
    next if FileTest.directory?(path) unless opts[:dirs]
    name = opts[:path] ? path : File.basename(path)
    if pattern.match(name)
      print path
      return
    end
  end
end

########################################
# MAIN BODY
########################################

if __FILE__ == $0    # this script can be required as a library
  main
end
